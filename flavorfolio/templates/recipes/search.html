{% extends 'recipes/base.html' %}
{% load static %}

{% block title_block %}
    FlavourFolio - {{ search.search_query }}
{% endblock %}

{% block header_block %}
<img src="{% static 'images/headers/search_header.png' %}" alt="Search Header">
{% endblock %}

{% block body_block %}
<link rel="stylesheet" href="{% static 'stylesheets/search_styles.css' %}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<div class="search-bar">
    <form method="GET" action="{% url 'recipes:search' %}">
        <div class="search-box">
            <input type="text" name="search_query" placeholder="Search Recipes..." value="{{ search_query }}">
            <button type="submit" class="search-bar-button">Search</button>
        </div>
        <div class="tag-filters">

            <input 
                type="text" 
                id="tagInput" 
                placeholder="Add tags (press Enter)"
                class="form-control mb-2"
            >
            <div id="hiddenTagsContainer">
                {% for tag in selected_tags %}
                <input type="hidden" name="tags" value="{{ tag }}">
                {% endfor %}
            </div>

            <div id="tagContainer" class="d-flex flex-wrap gap-2 mb-3">
                {% for tag in selected_tags %}
                <span class="badge bg-primary rounded-pill d-inline-flex align-items-center fs-6">
                    {{ tag }}
                    <button 
                        type="button" 
                        class="btn-close btn-close-white ms-2" 
                        aria-label="Remove"
                        data-tag="{{ tag }}"
                    ></button>
                </span>
                {% endfor %}
            </div>
        
    </form>
</div>
<div class="search-results-box" >
<ul class="recipe-list">
  {% if results %}
      {% for result in results %}
          <li>

          <div class="recipe-title-section">
              <a href="{% url 'recipes:recipe' result.0.id %}">{{ result.0.title }}</a> 
          </div>
          
          <div class="recipe-image-section">
              <a href="{% url 'recipes:recipe' result.0.id %}"> <img src="{{ result.0.image.url }}" class="recipe-image" alt=""> </a> 

          </div>

          <div class="tag-section">
              <h3>Recipe Tags:</h3>
              {% for tag in result.0.tag_set.all %}
              <div class="tag-box"><a href="{% url 'recipes:tag' tag.name %}">â€¢ {{ tag.name }}</a></div>
              {% endfor %}
          </div>
          </li>
      {% endfor %}

  {% else %}
      <p>No results found.</p>
  {% endif %}

</ul>
</div>
<script>
    document.getElementById('tagInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && this.value.trim() !== '') {
            e.preventDefault();
            addTag(this.value.trim());
            this.value = '';
        }
    });

    // Single event listener for tag removal
    document.getElementById('tagContainer').addEventListener('click', function(e) {
        if (e.target.classList.contains('btn-close')) {
            e.preventDefault();
            const tagName = e.target.getAttribute('data-tag');
            removeTag(tagName);
            e.target.closest('.badge').remove();
            document.getElementById('searchForm').submit();
        }
    });

    function normalizeTagCase(tagName){
    return tagName.trim()
        .toLowerCase()
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    }

    function addTag(rawTagName) {
        const tagName=normalizeTagCase(rawTagName);
        const tagContainer = document.getElementById('tagContainer');
        const hiddenTagsContainer = document.getElementById('hiddenTagsContainer');
        
        // Check for duplicates
        const existingTags = Array.from(hiddenTagsContainer.querySelectorAll('input[name="tags"]'))
                            .map(input => input.value);
        if (existingTags.includes(tagName)) return;

        // Add hidden input
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'tags';
        hiddenInput.value = tagName;
        hiddenTagsContainer.appendChild(hiddenInput);

        // Add visible pill
        const pill = document.createElement('span');
        pill.className = 'badge bg-primary rounded-pill d-inline-flex align-items-center me-2 fs-6';
        pill.innerHTML = `
            ${tagName}
            <button 
                type="button" 
                class="btn-close btn-close-white ms-2" 
                aria-label="Remove"
                data-tag="${tagName}"
            ></button>
        `;
        tagContainer.appendChild(pill);
    }

    function removeTag(tagName) {
        const hiddenTagsContainer = document.getElementById('hiddenTagsContainer');
        const inputs = hiddenTagsContainer.querySelectorAll('input[name="tags"]');
        
        inputs.forEach(input => {
            if (input.value === tagName) {
                input.remove();
            }
        });
    }
</script>
{% endblock %}

